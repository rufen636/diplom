# Руководство по модулю "Договоры"

## Описание

Модуль управления договорами позволяет создавать, редактировать, просматривать и удалять договоры с клиентами.

## Структура данных

### Таблица `contracts`

| Поле              | Тип           | Описание                              |
| ----------------- | ------------- | ------------------------------------- |
| `id`              | bigint        | Уникальный идентификатор              |
| `contract_number` | string        | Номер договора (уникальный)           |
| `title`           | string        | Название договора                     |
| `user_id`         | bigint        | ID клиента (связь с users)            |
| `start_date`      | date          | Дата начала договора                  |
| `end_date`        | date          | Дата окончания договора               |
| `amount`          | decimal(15,2) | Сумма договора в рублях               |
| `status`          | enum          | Статус: active, completed, terminated |
| `description`     | text          | Описание договора (опционально)       |
| `created_at`      | timestamp     | Дата создания                         |
| `updated_at`      | timestamp     | Дата обновления                       |

## Функционал

### 1. Список договоров (`/manager/contracts`)

**Возможности:**

-   Просмотр всех договоров в виде таблицы
-   Поиск по номеру договора, названию или клиенту
-   Фильтрация по статусу (активные, завершенные, расторгнутые)
-   Пагинация (10 договоров на страницу)
-   Быстрый доступ к редактированию и удалению

**Отображаемые данные:**

-   Номер договора
-   Название
-   Клиент (с аватаром)
-   Период действия (дата начала - дата окончания)
-   Сумма (в рублях)
-   Статус (с цветовой индикацией)

### 2. Создание договора (`/manager/contracts/create`)

**Поля формы:**

-   **Номер договора\*** - уникальный номер (например, ДГ-2024-001)
-   **Название договора\*** - краткое описание
-   **Клиент\*** - выбор из списка пользователей
-   **Дата начала\*** - дата начала действия договора
-   **Дата окончания\*** - дата окончания (должна быть позже даты начала)
-   **Сумма (₽)\*** - сумма в рублях
-   **Статус\*** - активный, завершен, расторгнут
-   **Описание** - дополнительная информация

**Валидация:**

-   Все обязательные поля должны быть заполнены
-   Номер договора должен быть уникальным
-   Дата окончания должна быть позже даты начала
-   Сумма должна быть положительным числом

### 3. Редактирование договора (`/manager/contracts/{id}/edit`)

Аналогично созданию, но с предзаполненными данными.

### 4. Удаление договора

Удаление с подтверждением через модальное окно.

## Статусы договоров

| Статус       | Описание             | Цвет индикатора |
| ------------ | -------------------- | --------------- |
| `active`     | Активный договор     | Зеленый         |
| `completed`  | Завершенный договор  | Синий           |
| `terminated` | Расторгнутый договор | Красный         |

## Интеграция с Dashboard

На главной странице менеджера отображается:

### Статистика по договорам:

-   **Всего договоров** - общее количество
-   **Активных договоров** - количество активных
-   **Общая сумма** - сумма всех договоров

### Последние договоры:

Таблица с 5 последними созданными договорами, содержащая:

-   Номер договора
-   Название
-   Клиента
-   Сумму
-   Статус

## Роуты

| Метод  | URL                            | Название                    | Контроллер                    | Описание             |
| ------ | ------------------------------ | --------------------------- | ----------------------------- | -------------------- |
| GET    | `/manager/contracts`           | `manager.contracts.index`   | `ContractsController@index`   | Список договоров     |
| GET    | `/manager/contracts/create`    | `manager.contracts.create`  | `ContractsController@create`  | Форма создания       |
| POST   | `/manager/contracts`           | `manager.contracts.store`   | `ContractsController@store`   | Сохранение нового    |
| GET    | `/manager/contracts/{id}/edit` | `manager.contracts.edit`    | `ContractsController@edit`    | Форма редактирования |
| PUT    | `/manager/contracts/{id}`      | `manager.contracts.update`  | `ContractsController@update`  | Обновление           |
| DELETE | `/manager/contracts/{id}`      | `manager.contracts.destroy` | `ContractsController@destroy` | Удаление             |

## Модель Contract

### Отношения:

-   `user()` - принадлежит пользователю (клиенту)

### Accessors:

-   `status_label` - статус на русском языке
-   `status_color` - CSS классы для цветовой индикации

### Примеры использования:

```php
// Создание договора
Contract::create([
    'contract_number' => 'ДГ-2024-001',
    'title' => 'Договор на разработку',
    'user_id' => 1,
    'start_date' => now(),
    'end_date' => now()->addMonths(6),
    'amount' => 500000.00,
    'status' => 'active',
    'description' => 'Описание договора'
]);

// Получение договора с клиентом
$contract = Contract::with('user')->find(1);

// Получение статуса на русском
echo $contract->status_label; // "Активный"

// Получение CSS классов для статуса
echo $contract->status_color; // "bg-green-100 text-green-800"
```

## Тестовые данные

Для тестирования создан `ContractSeeder`, который создает 8 тестовых договоров с различными статусами.

**Запуск seeder:**

```bash
php artisan db:seed --class=ContractSeeder
```

## Дизайн

### Цветовая схема:

-   **Основной цвет**: `#416081` (темно-синий) - для номеров договоров
-   **Вторичный цвет**: `#4E89A5` (бирюзовый) - для кнопок и ссылок
-   **Терракотовый**: `#B75D5D` - для удаления

### Компоненты:

-   Карточки с тенями
-   Таблицы с hover-эффектами
-   Цветовые индикаторы статусов
-   Модальные окна для подтверждений

## Безопасность

-   Все роуты защищены middleware `auth` и `verified`
-   Валидация всех входящих данных
-   Защита от CSRF атак
-   Уникальность номеров договоров

## Расширение функционала

### Возможные улучшения:

1. Экспорт договоров в PDF/Excel
2. История изменений договоров
3. Напоминания о приближающихся датах окончания
4. Прикрепление файлов к договорам
5. Статистика по договорам (графики, диаграммы)
6. Массовые операции (удаление, изменение статуса)
7. Поиск с автодополнением
8. Сортировка по различным полям

## Troubleshooting

### Проблема: Договоры не отображаются

**Решение:** Проверьте, что миграция выполнена:

```bash
php artisan migrate
```

### Проблема: Ошибка при создании договора

**Решение:** Проверьте валидацию и убедитесь, что:

-   Номер договора уникален
-   Дата окончания позже даты начала
-   Все обязательные поля заполнены

### Проблема: Не отображается клиент

**Решение:** Убедитесь, что в базе есть пользователи и `user_id` указан корректно.
